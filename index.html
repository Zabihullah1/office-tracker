<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Expense Tracker</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@300;400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #1e293b 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        
        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            color: #fbbf24;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #94a3b8;
            font-weight: 300;
        }
        
        .user-info {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .setup-banner {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border: 1px solid #ef4444;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .setup-banner.success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            border-color: #10b981;
        }
        
        .setup-banner .icon {
            font-size: 2rem;
        }
        
        .setup-banner .content {
            flex: 1;
        }
        
        .setup-banner h3 {
            font-size: 1.125rem;
            margin-bottom: 4px;
        }
        
        .setup-banner p {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .setup-banner button {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: 500;
        }
        
        .setup-banner button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #475569;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #334155;
        }
        
        .btn-success {
            background: #059669;
            color: white;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.875rem;
        }
        
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 30px;
            border-bottom: 2px solid #475569;
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab:hover {
            color: #fbbf24;
        }
        
        .tab.active {
            color: #fbbf24;
            border-bottom-color: #fbbf24;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }
        
        .summary-card.clickable {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .summary-card.clickable:hover {
            border-color: #fbbf24;
            transform: translateY(-2px);
        }
        
        .summary-card h3 {
            color: #fbbf24;
            font-size: 1.25rem;
            margin-bottom: 4px;
        }
        
        .summary-card .amount {
            font-size: 2rem;
            font-weight: 600;
            color: white;
            margin-top: 12px;
        }
        
        .summary-card .subtitle {
            color: #94a3b8;
            font-size: 0.875rem;
        }
        
        .summary-card.over-budget .amount {
            color: #ef4444;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }
        
        .category-card {
            background: #334155;
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 16px;
        }
        
        .category-card.over-budget {
            border-color: #ef4444;
        }
        
        .category-card h4 {
            color: white;
            font-size: 1rem;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #475569;
            border-radius: 3px;
            overflow: hidden;
            margin: 12px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
            transition: width 0.5s ease;
        }
        
        .progress-fill.over {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.875rem;
        }
        
        .stat-label {
            color: #94a3b8;
        }
        
        .stat-value {
            font-weight: 500;
        }
        
        .section {
            background: #334155;
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
        }
        
        .section h2 {
            color: #fbbf24;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #1e293b;
            padding: 12px;
            text-align: left;
            color: #94a3b8;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        td {
            padding: 12px;
            border-top: 1px solid #475569;
        }
        
        tr:hover {
            background: #3f4f5f;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .status-approved {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .status-rejected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .status-paid {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .status-unpaid {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #334155;
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-header h3 {
            color: #fbbf24;
            font-size: 1.5rem;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }
        
        .close-btn:hover {
            color: white;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: #e2e8f0;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #fbbf24;
        }
        
        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }
        
        .form-group .helper-text {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 4px;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .form-actions button {
            flex: 1;
        }
        
        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 0.875rem;
            color: #93c5fd;
        }
        
        .warning-box {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 0.875rem;
            color: #fbbf24;
        }
        
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.875rem;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-state p {
            color: #94a3b8;
            font-size: 1.125rem;
        }
        
        .empty-state small {
            color: #64748b;
            font-size: 0.875rem;
            display: block;
            margin-top: 8px;
        }
        
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filters select,
        .filters input {
            padding: 10px 16px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }
        
        .user-permissions-grid {
            display: grid;
            gap: 16px;
        }
        
        .user-permission-card {
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 16px;
        }
        
        .user-permission-card h4 {
            color: #fbbf24;
            margin-bottom: 12px;
        }
        
        .permission-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .permission-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .category-grid {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 0.875rem;
            }
            
            th, td {
                padding: 8px;
            }
            
            .tabs {
                font-size: 0.875rem;
            }
            
            .tab {
                padding: 10px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Office Expense Tracker</h1>
            <p>Track expenses with bank balance and budget management</p>
        </div>
        
        <div class="user-info" id="userInfo">
            <div>
                <strong>User:</strong> <span id="userName">Not logged in</span>
                <span id="userRole" style="margin-left: 12px; color: #fbbf24;"></span>
            </div>
            <button class="btn btn-secondary btn-small" onclick="logout()">Change User</button>
        </div>
        
        <!-- Setup Banner -->
        <div id="setupBanner" class="setup-banner">
            <div class="icon">‚ö†Ô∏è</div>
            <div class="content">
                <h3>Google Sheets Not Connected</h3>
                <p>Configure your Google Sheets connection to start tracking</p>
            </div>
            <button onclick="openSetupModal()">Setup Now</button>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
            <div class="sync-status" id="syncStatus">
                <div class="loading"></div>
                <span>Syncing...</span>
            </div>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
                <button class="btn btn-secondary" onclick="openBankBalanceModal()" id="bankBalanceBtn" style="display: none;">üí∞ Bank Balance</button>
                <button class="btn btn-secondary" onclick="openCategoryModal()" id="manageCategoriesBtn" style="display: none;">üìù Manage Budgets</button>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')" id="dashboardTab">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('expenses')" id="expensesTab">üí∞ Submit Expense</button>
            <button class="tab" onclick="switchTab('history')" id="historyTab">üìã History</button>
            <button class="tab" onclick="switchTab('budgetnotes')" id="budgetNotesTab">üí¨ Budget Notes</button>
            <button class="tab" id="approvalsTab" onclick="switchTab('approvals')" style="display: none;">‚úÖ Approvals</button>
            <button class="tab" id="usersTab" onclick="switchTab('users')" style="display: none;">üë• Manage Users</button>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="summary-grid">
                <div class="summary-card" id="bankBalanceCard">
                    <h3>Bank Balance</h3>
                    <div class="subtitle">Available Funds</div>
                    <div class="amount" id="bankBalance">PKR 0</div>
                </div>
                <div class="summary-card">
                    <h3>Total Expenses</h3>
                    <div class="subtitle">Approved Only</div>
                    <div class="amount" id="totalExpenses">PKR 0</div>
                </div>
                <div class="summary-card" id="savingsCard" style="display: none;">
                    <h3>Company Savings</h3>
                    <div class="subtitle">Admin Only</div>
                    <div class="amount" id="companySavings">PKR 0</div>
                </div>
                <div class="summary-card" id="pendingCard" style="display: none;">
                    <h3>Pending Approvals</h3>
                    <div class="subtitle">Awaiting Review</div>
                    <div class="amount" id="pendingCount">0</div>
                </div>
            </div>
            
            <div class="section" id="categorySection">
                <h2>Category Breakdown</h2>
                <div id="categoryGrid" class="category-grid"></div>
            </div>
            
            <div class="section">
                <h2>Recent Activity</h2>
                <div id="recentActivity"></div>
            </div>
        </div>
        
        <!-- Submit Expense Tab -->
        <div id="expenses" class="tab-content">
            <div class="section">
                <h2>Submit New Expense</h2>
                <form id="expenseForm" onsubmit="submitExpense(event)">
                    <div class="form-group">
                        <label>Category Type</label>
                        <select id="expenseCategoryType" onchange="updateExpenseCategories()" required>
                            <option value="">Select type...</option>
                            <option value="Variable Cost - Salary">Variable Cost - Salary</option>
                            <option value="Variable Cost - Operational">Variable Cost - Operational</option>
                            <option value="Fixed Cost - Subscription">Fixed Cost - Subscription</option>
                            <option value="One Time Cost - Description">One Time Cost - Description</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Category</label>
                        <select id="expenseCategory" required>
                            <option value="">Select category type first...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Amount (PKR)</label>
                        <input type="number" id="expenseAmount" placeholder="0" required min="0" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label>Expense Date</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="expenseDueDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Date Type</label>
                        <select id="expenseDateType" required>
                            <option value="Fixed">Fixed</option>
                            <option value="Tentative">Tentative</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Payment Status</label>
                        <select id="expenseStatus" required>
                            <option value="Unpaid">Unpaid</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Description / Notes</label>
                        <textarea id="expenseNotes" placeholder="Add details about this expense..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Submit for Approval</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div class="section">
                <h2>Transaction History</h2>
                
                <div class="filters">
                    <select id="filterStatus" onchange="renderHistory()">
                        <option value="all">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                    <select id="filterPayment" onchange="renderHistory()">
                        <option value="all">All Payments</option>
                        <option value="Paid">Paid</option>
                        <option value="Unpaid">Unpaid</option>
                    </select>
                    <input type="date" id="filterDateFrom" onchange="renderHistory()" placeholder="From">
                    <input type="date" id="filterDateTo" onchange="renderHistory()" placeholder="To">
                </div>
                
                <div id="historyTable"></div>
            </div>
        </div>
        
        <!-- Approvals Tab (Admin Only) -->
        <div id="approvals" class="tab-content">
            <div class="section">
                <h2>Pending Approvals</h2>
                <div id="approvalsTable"></div>
            </div>
        </div>
        
        <!-- Budget Notes Tab -->
        <div id="budgetnotes" class="tab-content">
            <div class="section">
                <h2>Budget Notes & Justifications</h2>
                <div class="info-box">
                    üí¨ Use this to explain budget overruns or ask team members about exceeded categories
                </div>
                
                <!-- Add New Note Form -->
                <div style="background: #1e293b; border: 1px solid #475569; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                    <h3 style="color: #fbbf24; margin-bottom: 16px;">Add Budget Note</h3>
                    <form id="budgetNoteForm" onsubmit="addBudgetNote(event)">
                        <div class="form-group">
                            <label>Category</label>
                            <select id="noteCategory" required>
                                <option value="">Select category...</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="noteToUserGroup" style="display: none;">
                            <label>To (User)</label>
                            <select id="noteToUser">
                                <option value="">Select user to ask...</option>
                            </select>
                            <div class="helper-text">Admin: Select user to ask about budget overrun</div>
                        </div>
                        
                        <div class="form-group">
                            <label>Note Type</label>
                            <select id="noteType" required onchange="toggleNoteToUser()">
                                <option value="explanation">üìù Explanation (Why I exceeded budget)</option>
                                <option value="question">‚ùì Question (Ask about overrun)</option>
                                <option value="response">üí¨ Response (Reply to question)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Message</label>
                            <textarea id="noteMessage" placeholder="Explain why the budget was exceeded or ask for clarification..." required style="min-height: 100px;"></textarea>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">üì§ Submit Note</button>
                        </div>
                    </form>
                </div>
                
                <!-- Notes Filter -->
                <div class="filters" style="margin-bottom: 20px;">
                    <select id="filterNoteCategory" onchange="renderBudgetNotes()">
                        <option value="all">All Categories</option>
                    </select>
                    <select id="filterNoteType" onchange="renderBudgetNotes()">
                        <option value="all">All Types</option>
                        <option value="explanation">üìù Explanations</option>
                        <option value="question">‚ùì Questions</option>
                        <option value="response">üí¨ Responses</option>
                    </select>
                </div>
                
                <!-- Notes List -->
                <div id="budgetNotesList"></div>
            </div>
        </div>
        
        <!-- Manage Users Tab (Admin Only) -->
        <div id="users" class="tab-content">
            <div class="section">
                <h2>Manage User Permissions</h2>
                <div class="info-box">
                    ‚ÑπÔ∏è Control what each user can see in the tracker
                </div>
                <div id="userPermissionsGrid" class="user-permissions-grid"></div>
            </div>
        </div>
    </div>
    
    <!-- Bank Balance Modal -->
    <div id="bankBalanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Bank Balance</h3>
                <button class="close-btn" onclick="closeBankBalanceModal()">√ó</button>
            </div>
            
            <div class="info-box">
                Current Balance: <strong id="currentBalanceDisplay">PKR 0</strong>
            </div>
            
            <div class="form-group">
                <label>Add Incoming Funds (Monthly Invoice)</label>
                <input type="number" id="incomingFunds" placeholder="0" min="0" step="0.01">
                <button class="btn btn-success" onclick="addIncomingFunds()" style="margin-top: 8px; width: 100%;">
                    ‚ûï Add to Balance
                </button>
            </div>
            
            <hr style="border-color: #475569; margin: 20px 0;">
            
            <div class="form-group">
                <label>Move to Company Savings</label>
                <input type="number" id="savingsAmount" placeholder="0" min="0" step="0.01">
                <button class="btn btn-secondary" onclick="moveToSavings()" style="margin-top: 8px; width: 100%;">
                    üíº Move to Savings
                </button>
            </div>
            
            <div class="warning-box" style="margin-top: 16px;">
                ‚ö†Ô∏è Company Savings are only visible to admin
            </div>
            
            <button class="btn btn-secondary" onclick="closeBankBalanceModal()" style="margin-top: 16px; width: 100%;">
                Close
            </button>
        </div>
    </div>
    
    <!-- Setup Modal -->
    <div id="setupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Setup</h3>
                <button class="close-btn" onclick="closeSetupModal()">√ó</button>
            </div>
            
            <form id="setupForm" onsubmit="saveSetup(event)">
                <div class="form-group">
                    <label>Your Name</label>
                    <input type="text" id="setupUserName" placeholder="Enter your name" required>
                </div>
                
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="setupUserPassword" placeholder="Create a password" required minlength="4">
                </div>
                
                <div class="form-group">
                    <label>Your Role</label>
                    <select id="setupUserRole" required>
                        <option value="">Select your role...</option>
                        <option value="admin">Admin (Zabih Ullah)</option>
                        <option value="ceo">CEO - Expenses auto-approved</option>
                        <option value="member">Team Member</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Google Sheets Web App URL</label>
                    <input 
                        type="url" 
                        id="webAppUrl" 
                        placeholder="https://script.google.com/macros/s/YOUR_ID/exec"
                        required
                    >
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeSetupModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save & Connect</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Manage Categories Modal -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Category Budgets</h3>
                <button class="close-btn" onclick="closeCategoryModal()">√ó</button>
            </div>
            
            <div class="info-box">
                ‚ÑπÔ∏è Set monthly budgets for each category. All users share these budgets.
            </div>
            
            <div class="form-group">
                <label>Category Type</label>
                <select id="manageCategoryType" onchange="displayCategoryBudgets()">
                    <option value="Variable Cost - Salary">Variable Cost - Salary</option>
                    <option value="Variable Cost - Operational">Variable Cost - Operational</option>
                    <option value="Fixed Cost - Subscription">Fixed Cost - Subscription</option>
                    <option value="One Time Cost - Description">One Time Cost - Description</option>
                </select>
            </div>
            
            <div id="categoryBudgetList" style="margin: 20px 0;"></div>
            
            <button class="btn btn-secondary" onclick="closeCategoryModal()" style="width: 100%;">
                Close
            </button>
        </div>
    </div>
    
    <script>
        // Initialize categories with budgets
        let categoryBudgets = {
            'Variable Cost - Salary': {
                'Basic Salary': 0,
                'Monthly FBR': 0,
                'Saturday Over Time': 0,
                'Late Shift': 0
            },
            'Variable Cost - Operational': {
                'Attendence Portal': 0,
                'Chat GPT Subscription': 0,
                'Employee Post, Freight and Travelling Expenses': 0,
                'Employee Mobile Expense': 0,
                'Grocery and Crockery Expense': 0,
                'Team/s Lunch Expense': 0,
                'Electricity Bill (31-A)': 0,
                'Wasa Bill (31-A)': 0,
                'Jarrar Security Services': 0,
                'Repair and Maintenance': 0,
                'Water Supply': 0,
                'Employee Gym Fee': 0,
                'UPS Repair and Maintenance': 0,
                'Diesel Supply for Genset': 0,
                'Miscellaneous Expense': 0,
                'Office Furniture': 0,
                'Pak Qatar Insurance': 0,
                'Employee Activity Expense': 0,
                'Entertainment Expense': 0,
                'Ramzan Expense': 0,
                'Lift Service Agreement': 0,
                'IP Royal': 0,
                'Stationary Expense': 0,
                'Generator Service Agreement': 0,
                'Computer and Hardware': 0,
                'Employee Loans/Advances': 0
            },
            'Fixed Cost - Subscription': {
                'MultiMD CRM 20Mbps': 0,
                'Wateen Telecom': 0,
                'Ptcl': 0,
                'Storm Fiber': 0
            },
            'One Time Cost - Description': {
                'Exchange rate difference': 0,
                'Fed Duty 1% of overall invoice': 0
            }
        };
        
        let expenses = [];
        let webAppUrl = localStorage.getItem('officeWebAppUrl') || '';
        let userName = localStorage.getItem('officeUserName') || '';
        let userPassword = localStorage.getItem('officeUserPassword') || '';
        let isAdmin = localStorage.getItem('officeIsAdmin') === 'true';
        let isCEO = localStorage.getItem('officeIsCEO') === 'true';
        let bankBalance = parseFloat(localStorage.getItem('officeBankBalance') || '0');
        let companySavings = parseFloat(localStorage.getItem('officeCompanySavings') || '0');
        let userPermissions = JSON.parse(localStorage.getItem('officeUserPermissions') || '{}');
        let registeredUsers = [];
        
        function updateSyncStatus(message, isError = false) {
            const status = document.getElementById('syncStatus');
            if (isError) {
                status.innerHTML = `<span style="color: #ef4444;">‚ö†Ô∏è</span><span>${message}</span>`;
            } else if (message === 'loading') {
                status.innerHTML = `<div class="loading"></div><span>Syncing...</span>`;
            } else {
                status.innerHTML = `<span style="color: #10b981;">‚úì</span><span>${message}</span>`;
            }
        }
        
        function checkSetup() {
            if (!webAppUrl || !userName || !userPassword) {
                document.getElementById('setupBanner').style.display = 'flex';
                updateSyncStatus('Not connected', true);
                return false;
            } else {
                document.getElementById('setupBanner').style.display = 'none';
                document.getElementById('userName').textContent = userName;
                
                let roleText = '';
                if (isCEO) {
                    roleText = '(CEO)';
                } else if (isAdmin) {
                    roleText = '(Admin)';
                } else {
                    roleText = '(Team Member)';
                }
                document.getElementById('userRole').textContent = roleText;
                
                if (isAdmin) {
                    document.getElementById('approvalsTab').style.display = 'block';
                    document.getElementById('usersTab').style.display = 'block';
                    document.getElementById('pendingCard').style.display = 'block';
                    document.getElementById('manageCategoriesBtn').style.display = 'inline-flex';
                    document.getElementById('bankBalanceBtn').style.display = 'inline-flex';
                    document.getElementById('savingsCard').style.display = 'block';
                }
                
                // Check user permissions
                applyUserPermissions();
                
                return true;
            }
        }
        
        function applyUserPermissions() {
            const perms = userPermissions[userName] || {
                canSeeDashboard: true,
                canSeeHistory: true,
                canSeeBankBalance: false, // DEFAULT: HIDE from non-admins
                canSeeCategoryBreakdown: true
            };
            
            // Apply permissions (unless admin or CEO)
            if (!isAdmin && !isCEO) {
                if (!perms.canSeeDashboard) {
                    document.getElementById('dashboardTab').style.display = 'none';
                }
                if (!perms.canSeeHistory) {
                    document.getElementById('historyTab').style.display = 'none';
                }
                if (!perms.canSeeBankBalance) {
                    document.getElementById('bankBalanceCard').style.display = 'none';
                }
                if (!perms.canSeeCategoryBreakdown) {
                    document.getElementById('categorySection').style.display = 'none';
                }
            }
        }
        
        async function loadData() {
            if (!checkSetup()) return;
            
            updateSyncStatus('loading');
            
            try {
                const response = await fetch(webAppUrl);
                const data = await response.json();
                
                expenses = data.expenses || [];
                registeredUsers = data.registeredUsers || [];
                budgetNotes = data.budgetNotes || [];
                
                if (data.categoryBudgets && Object.keys(data.categoryBudgets).length > 0) {
                    categoryBudgets = data.categoryBudgets;
                } else {
                    await syncCategoryBudgets();
                }
                
                if (data.bankBalance !== undefined) {
                    bankBalance = data.bankBalance;
                    localStorage.setItem('officeBankBalance', bankBalance);
                }
                
                if (data.companySavings !== undefined && isAdmin) {
                    companySavings = data.companySavings;
                    localStorage.setItem('officeCompanySavings', companySavings);
                }
                
                if (data.userPermissions) {
                    userPermissions = data.userPermissions;
                    localStorage.setItem('officeUserPermissions', JSON.stringify(userPermissions));
                }
                
                updateSyncStatus('Synced');
                renderAll();
                
                // Populate Budget Notes dropdowns
                populateNoteCategoryDropdown();
                renderBudgetNotes();
                
            } catch (error) {
                console.error('Error loading data:', error);
                updateSyncStatus('Sync failed', true);
                alert('Failed to load data from Google Sheets. Please check your setup.');
            }
        }
        
        async function syncCategoryBudgets() {
            if (!checkSetup()) return false;
            
            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'updateCategoryBudgets',
                        categoryBudgets: categoryBudgets
                    })
                });
                
                const result = await response.json();
                return result.success;
            } catch (error) {
                console.error('Error syncing category budgets:', error);
                return false;
            }
        }
        
        async function syncData(action, data) {
            if (!checkSetup()) return false;
            
            updateSyncStatus('loading');
            
            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action,
                        ...data
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateSyncStatus('Synced');
                    return true;
                } else {
                    updateSyncStatus('Sync failed', true);
                    return false;
                }
            } catch (error) {
                console.error('Error syncing:', error);
                updateSyncStatus('Sync failed', true);
                alert('Failed to sync with Google Sheets. Please try again.');
                return false;
            }
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        function openSetupModal() {
            document.getElementById('setupModal').classList.add('active');
            if (webAppUrl) {
                document.getElementById('webAppUrl').value = webAppUrl;
                document.getElementById('setupUserName').value = userName;
                document.getElementById('setupUserPassword').value = userPassword;
                
                let role = 'member';
                if (isAdmin) role = 'admin';
                else if (isCEO) role = 'ceo';
                document.getElementById('setupUserRole').value = role;
            }
        }
        
        function closeSetupModal() {
            document.getElementById('setupModal').classList.remove('active');
        }
        
        function saveSetup(event) {
            event.preventDefault();
            
            const url = document.getElementById('webAppUrl').value.trim();
            const name = document.getElementById('setupUserName').value.trim();
            const password = document.getElementById('setupUserPassword').value;
            const role = document.getElementById('setupUserRole').value;
            
            if (!url.includes('script.google.com')) {
                alert('Please enter a valid Google Apps Script Web App URL');
                return;
            }
            
            if (password.length < 4) {
                alert('Password must be at least 4 characters');
                return;
            }
            
            webAppUrl = url;
            userName = name;
            userPassword = password;
            isAdmin = (role === 'admin');
            isCEO = (role === 'ceo');
            
            localStorage.setItem('officeWebAppUrl', url);
            localStorage.setItem('officeUserName', name);
            localStorage.setItem('officeUserPassword', password);
            localStorage.setItem('officeIsAdmin', isAdmin);
            localStorage.setItem('officeIsCEO', isCEO);
            
            // Set default permissions for non-admin users
            if (!isAdmin && !isCEO) {
                if (!userPermissions[name]) {
                    userPermissions[name] = {
                        canSeeDashboard: true,
                        canSeeHistory: true,
                        canSeeBankBalance: false, // HIDDEN by default
                        canSeeCategoryBreakdown: true
                    };
                    localStorage.setItem('officeUserPermissions', JSON.stringify(userPermissions));
                }
                registerUser(name);
            }
            
            document.getElementById('setupBanner').innerHTML = `
                <div class="icon">‚úì</div>
                <div class="content">
                    <h3>Connected to Google Sheets</h3>
                    <p>Your data is now syncing</p>
                </div>
                <button onclick="openSetupModal()">Reconfigure</button>
            `;
            document.getElementById('setupBanner').className = 'setup-banner success';
            
            closeSetupModal();
            checkSetup();
            loadData();
        }
        
        async function registerUser(name) {
            // Register new user and sync their default permissions
            await syncData('registerUser', { userName: name });
            await syncData('updateUserPermissions', { userPermissions });
        }
        
        function logout() {
            const enteredPassword = prompt('Enter your password to change user:');
            
            if (!enteredPassword) {
                return;
            }
            
            if (enteredPassword !== userPassword) {
                alert('Incorrect password!');
                return;
            }
            
            if (confirm('Change user? This will log you out.')) {
                localStorage.removeItem('officeUserName');
                localStorage.removeItem('officeUserPassword');
                localStorage.removeItem('officeIsAdmin');
                localStorage.removeItem('officeIsCEO');
                userName = '';
                userPassword = '';
                isAdmin = false;
                isCEO = false;
                location.reload();
            }
        }
        
        function updateExpenseCategories() {
            const type = document.getElementById('expenseCategoryType').value;
            const select = document.getElementById('expenseCategory');
            
            if (!type) {
                select.innerHTML = '<option value="">Select category type first...</option>';
                return;
            }
            
            const categories = Object.keys(categoryBudgets[type] || {});
            select.innerHTML = '<option value="">Select category...</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }
        
        async function submitExpense(event) {
            event.preventDefault();
            
            const expense = {
                id: Date.now(),
                categoryType: document.getElementById('expenseCategoryType').value,
                category: document.getElementById('expenseCategory').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                date: document.getElementById('expenseDate').value,
                dueDate: document.getElementById('expenseDueDate').value,
                dateType: document.getElementById('expenseDateType').value,
                paymentStatus: document.getElementById('expenseStatus').value,
                notes: document.getElementById('expenseNotes').value,
                submittedBy: userName,
                status: isCEO ? 'Approved' : 'Pending',
                submittedAt: new Date().toISOString()
            };
            
            if (isCEO) {
                expense.approvedBy = userName + ' (CEO - Auto-approved)';
            }
            
            const success = await syncData('addExpense', expense);
            
            if (success) {
                if (isCEO) {
                    alert('Expense added and auto-approved!');
                } else {
                    alert('Expense submitted for approval!');
                }
                document.getElementById('expenseForm').reset();
                await loadData();
                switchTab('history');
            }
        }
        
        async function approveExpense(id) {
            const success = await syncData('approveExpense', { id, approvedBy: userName });
            if (success) {
                await loadData();
            }
        }
        
        async function rejectExpense(id) {
            const reason = prompt('Reason for rejection (optional):');
            const success = await syncData('rejectExpense', { id, rejectedBy: userName, reason });
            if (success) {
                await loadData();
            }
        }
        
        function openBankBalanceModal() {
            document.getElementById('bankBalanceModal').classList.add('active');
            document.getElementById('currentBalanceDisplay').textContent = formatCurrency(bankBalance);
        }
        
        function closeBankBalanceModal() {
            document.getElementById('bankBalanceModal').classList.remove('active');
        }
        
        async function addIncomingFunds() {
            const amount = parseFloat(document.getElementById('incomingFunds').value);
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            bankBalance += amount;
            localStorage.setItem('officeBankBalance', bankBalance);
            
            const success = await syncData('updateBankBalance', { bankBalance });
            
            if (success) {
                alert(`Added ${formatCurrency(amount)} to bank balance!`);
                document.getElementById('incomingFunds').value = '';
                document.getElementById('currentBalanceDisplay').textContent = formatCurrency(bankBalance);
                renderAll();
            }
        }
        
        async function moveToSavings() {
            const amount = parseFloat(document.getElementById('savingsAmount').value);
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            if (amount > bankBalance) {
                alert('Insufficient bank balance!');
                return;
            }
            
            bankBalance -= amount;
            companySavings += amount;
            
            localStorage.setItem('officeBankBalance', bankBalance);
            localStorage.setItem('officeCompanySavings', companySavings);
            
            const success = await syncData('updateFinancials', { 
                bankBalance, 
                companySavings 
            });
            
            if (success) {
                alert(`Moved ${formatCurrency(amount)} to company savings!`);
                document.getElementById('savingsAmount').value = '';
                document.getElementById('currentBalanceDisplay').textContent = formatCurrency(bankBalance);
                renderAll();
            }
        }
        
        function openCategoryModal() {
            document.getElementById('categoryModal').classList.add('active');
            displayCategoryBudgets();
        }
        
        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
        }
        
        function displayCategoryBudgets() {
            const type = document.getElementById('manageCategoryType').value;
            const categories = categoryBudgets[type];
            const container = document.getElementById('categoryBudgetList');
            
            container.innerHTML = `
                <div style="background: #1e293b; border: 1px solid #475569; border-radius: 8px; padding: 16px;">
                    <h4 style="color: #fbbf24; margin-bottom: 12px; font-size: 1rem;">Category Budgets</h4>
                    ${Object.entries(categories).map(([name, budget]) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #475569; gap: 12px;">
                            <div style="flex: 1;">
                                <div style="color: white; font-weight: 500; margin-bottom: 4px;">${name}</div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input 
                                        type="number" 
                                        id="budget_${type}_${name.replace(/[^a-zA-Z0-9]/g, '_')}"
                                        value="${budget}"
                                        min="0"
                                        step="1000"
                                        style="width: 150px; padding: 6px 10px; background: #334155; border: 1px solid #475569; border-radius: 6px; color: white; font-size: 0.875rem;"
                                        onchange="updateCategoryBudget('${type}', '${name}', this.value)"
                                    >
                                    <span style="color: #94a3b8; font-size: 0.75rem;">PKR</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        async function updateCategoryBudget(type, categoryName, newBudget) {
            const amount = parseFloat(newBudget);
            
            if (isNaN(amount) || amount < 0) {
                alert('Please enter a valid budget amount');
                displayCategoryBudgets();
                return;
            }
            
            const oldBudget = categoryBudgets[type][categoryName];
            categoryBudgets[type][categoryName] = amount;
            
            const success = await syncCategoryBudgets();
            
            if (success) {
                renderAll();
                const input = document.getElementById(`budget_${type}_${categoryName.replace(/[^a-zA-Z0-9]/g, '_')}`);
                if (input) {
                    input.style.borderColor = '#10b981';
                    setTimeout(() => {
                        input.style.borderColor = '#475569';
                    }, 1000);
                }
            } else {
                categoryBudgets[type][categoryName] = oldBudget;
                alert('Failed to sync budget change. Please try again.');
                displayCategoryBudgets();
            }
        }
        
        function formatCurrency(amount) {
            return 'PKR ' + amount.toLocaleString('en-PK');
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }
        
        function calculateCategoryTotals() {
            const totals = {};
            
            Object.keys(categoryBudgets).forEach(type => {
                totals[type] = {};
                Object.keys(categoryBudgets[type]).forEach(category => {
                    const spent = expenses
                        .filter(e => e.status === 'Approved' && e.categoryType === type && e.category === category)
                        .reduce((sum, e) => sum + parseFloat(e.amount), 0);
                    
                    const budget = categoryBudgets[type][category];
                    totals[type][category] = {
                        budget,
                        spent,
                        remaining: budget - spent,
                        percentage: budget > 0 ? (spent / budget) * 100 : 0
                    };
                });
            });
            
            return totals;
        }
        
        function renderAll() {
            renderDashboard();
            renderHistory();
            if (isAdmin) {
                renderApprovals();
                renderUserPermissions();
            }
        }
        
        function renderDashboard() {
            // Calculate totals
            const totalExpenses = expenses
                .filter(e => e.status === 'Approved')
                .reduce((sum, e) => sum + parseFloat(e.amount), 0);
            
            const pendingCount = expenses.filter(e => e.status === 'Pending').length;
            
            // Update bank balance (subtract expenses)
            const availableBalance = bankBalance - totalExpenses;
            
            document.getElementById('bankBalance').textContent = formatCurrency(availableBalance);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            
            if (isAdmin) {
                document.getElementById('companySavings').textContent = formatCurrency(companySavings);
                document.getElementById('pendingCount').textContent = pendingCount;
            }
            
            // Render category breakdown
            const totals = calculateCategoryTotals();
            const container = document.getElementById('categoryGrid');
            
            let allCategories = [];
            Object.keys(totals).forEach(type => {
                Object.entries(totals[type]).forEach(([category, data]) => {
                    if (data.spent > 0 || data.budget > 0) {
                        allCategories.push({ type, category, ...data });
                    }
                });
            });
            
            if (allCategories.length === 0) {
                container.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">No spending data yet</p>';
                return;
            }
            
            container.innerHTML = allCategories.map(item => {
                const isOver = item.spent > item.budget;
                return `
                    <div class="category-card ${isOver ? 'over-budget' : ''}">
                        <h4>
                            <span>${item.category}</span>
                            ${isOver ? '<span style="color: #ef4444; font-size: 16px;">‚ö†Ô∏è</span>' : ''}
                        </h4>
                        <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 12px;">${item.type}</div>
                        
                        <div style="font-size: 0.875rem; margin-bottom: 12px;">
                            <div class="stat-row">
                                <span class="stat-label">Budget:</span>
                                <span style="color: white;">${formatCurrency(item.budget)}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Spent:</span>
                                <span style="color: ${isOver ? '#ef4444' : '#fbbf24'}">${formatCurrency(item.spent)}</span>
                            </div>
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress-fill ${isOver ? 'over' : ''}" style="width: ${Math.min(item.percentage, 100)}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Recent activity
            const recentExpenses = expenses
                .sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt))
                .slice(0, 10);
            
            const activityContainer = document.getElementById('recentActivity');
            
            if (recentExpenses.length === 0) {
                activityContainer.innerHTML = '<div class="empty-state"><p>No activity yet</p><small>Start by submitting an expense</small></div>';
                return;
            }
            
            activityContainer.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th style="text-align: right;">Amount</th>
                            <th>Status</th>
                            <th>Payment</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentExpenses.map(e => `
                            <tr>
                                <td>${formatDate(e.date)}</td>
                                <td>${e.category}</td>
                                <td style="text-align: right; font-weight: 500;">${formatCurrency(e.amount)}</td>
                                <td><span class="status-badge status-${e.status.toLowerCase()}">${e.status}</span></td>
                                <td><span class="status-badge status-${e.paymentStatus.toLowerCase()}">${e.paymentStatus}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function renderHistory() {
            const statusFilter = document.getElementById('filterStatus').value;
            const paymentFilter = document.getElementById('filterPayment').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            
            let filtered = expenses.filter(e => true);
            
            if (statusFilter !== 'all') {
                filtered = filtered.filter(e => e.status === statusFilter);
            }
            
            if (paymentFilter !== 'all') {
                filtered = filtered.filter(e => e.paymentStatus === paymentFilter);
            }
            
            if (dateFrom) {
                filtered = filtered.filter(e => new Date(e.date) >= new Date(dateFrom));
            }
            
            if (dateTo) {
                filtered = filtered.filter(e => new Date(e.date) <= new Date(dateTo));
            }
            
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const container = document.getElementById('historyTable');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No transactions found</p><small>Try adjusting your filters</small></div>';
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Due Date</th>
                            <th>Category</th>
                            <th style="text-align: right;">Amount</th>
                            <th>Status</th>
                            <th>Payment</th>
                            <th>Date Type</th>
                            <th>Submitted By</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(e => `
                            <tr>
                                <td>${formatDate(e.date)}</td>
                                <td>${formatDate(e.dueDate)}</td>
                                <td>${e.category}</td>
                                <td style="text-align: right; font-weight: 500;">${formatCurrency(e.amount)}</td>
                                <td><span class="status-badge status-${e.status.toLowerCase()}">${e.status}</span></td>
                                <td><span class="status-badge status-${e.paymentStatus.toLowerCase()}">${e.paymentStatus}</span></td>
                                <td style="font-size: 0.875rem;">${e.dateType}</td>
                                <td>${e.submittedBy}</td>
                                <td style="font-size: 0.875rem; color: #94a3b8;">${e.notes || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function renderApprovals() {
            const pending = expenses.filter(e => e.status === 'Pending');
            const container = document.getElementById('approvalsTable');
            
            if (pending.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No pending approvals</p><small>All expenses have been reviewed</small></div>';
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Submitted By</th>
                            <th>Category</th>
                            <th style="text-align: right;">Amount</th>
                            <th>Due Date</th>
                            <th>Payment</th>
                            <th>Notes</th>
                            <th style="text-align: right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pending.map(e => `
                            <tr>
                                <td>${formatDate(e.date)}</td>
                                <td>${e.submittedBy}</td>
                                <td>${e.category}</td>
                                <td style="text-align: right; font-weight: 500;">${formatCurrency(e.amount)}</td>
                                <td>${formatDate(e.dueDate)}</td>
                                <td><span class="status-badge status-${e.paymentStatus.toLowerCase()}">${e.paymentStatus}</span></td>
                                <td style="font-size: 0.875rem; color: #94a3b8;">${e.notes || '-'}</td>
                                <td style="text-align: right;">
                                    <button class="btn btn-success btn-small" onclick="approveExpense(${e.id})">‚úì Approve</button>
                                    <button class="btn btn-danger btn-small" onclick="rejectExpense(${e.id})">‚úï Reject</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function renderUserPermissions() {
            // Get users from expenses + anyone in userPermissions (excluding current admin)
            const expenseUsers = [...new Set(expenses.map(e => e.submittedBy))];
            const permissionUsers = Object.keys(userPermissions);
            const allUsers = [...new Set([...expenseUsers, ...permissionUsers, ...registeredUsers])];
            const users = allUsers.filter(u => u !== userName && u);
            
            const container = document.getElementById('userPermissionsGrid');
            
            if (users.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No other users yet</p><small>Users will appear here after they submit their first expense</small></div>';
                return;
            }
            
            container.innerHTML = users.map(user => {
                const perms = userPermissions[user] || {
                    canSeeDashboard: true,
                    canSeeHistory: true,
                    canSeeBankBalance: false,
                    canSeeCategoryBreakdown: true
                };
                
                return `
                    <div class="user-permission-card">
                        <h4>${user}</h4>
                        <div class="permission-checkboxes">
                            <div class="permission-item">
                                <input type="checkbox" id="perm_${user}_dashboard" ${perms.canSeeDashboard ? 'checked' : ''} onchange="updatePermission('${user}', 'canSeeDashboard', this.checked)">
                                <label for="perm_${user}_dashboard">Can see Dashboard</label>
                            </div>
                            <div class="permission-item">
                                <input type="checkbox" id="perm_${user}_history" ${perms.canSeeHistory ? 'checked' : ''} onchange="updatePermission('${user}', 'canSeeHistory', this.checked)">
                                <label for="perm_${user}_history">Can see History</label>
                            </div>
                            <div class="permission-item">
                                <input type="checkbox" id="perm_${user}_balance" ${perms.canSeeBankBalance ? 'checked' : ''} onchange="updatePermission('${user}', 'canSeeBankBalance', this.checked)">
                                <label for="perm_${user}_balance">Can see Bank Balance</label>
                            </div>
                            <div class="permission-item">
                                <input type="checkbox" id="perm_${user}_categories" ${perms.canSeeCategoryBreakdown ? 'checked' : ''} onchange="updatePermission('${user}', 'canSeeCategoryBreakdown', this.checked)">
                                <label for="perm_${user}_categories">Can see Category Breakdown</label>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function updatePermission(user, permission, value) {
            if (!userPermissions[user]) {
                userPermissions[user] = {
                    canSeeDashboard: true,
                    canSeeHistory: true,
                    canSeeBankBalance: false,
                    canSeeCategoryBreakdown: true
                };
            }
            
            userPermissions[user][permission] = value;
            localStorage.setItem('officeUserPermissions', JSON.stringify(userPermissions));
            
            const success = await syncData('updateUserPermissions', { userPermissions });
            
            if (success) {
                console.log(`Updated ${user}'s ${permission} to ${value}`);
            } else {
                alert('Failed to sync permissions. Please try again.');
                // Revert
                userPermissions[user][permission] = !value;
                document.getElementById(`perm_${user}_${permission.replace('canSee', '').toLowerCase()}`).checked = !value;
            }
        }
        
        async function refreshData() {
            await loadData();
        }
        
        // Budget Notes Functions
        let budgetNotes = [];
        
        function toggleNoteToUser() {
            const noteType = document.getElementById('noteType').value;
            const toUserGroup = document.getElementById('noteToUserGroup');
            
            if (noteType === 'question' && isAdmin) {
                toUserGroup.style.display = 'block';
                populateNoteUserDropdown();
            } else {
                toUserGroup.style.display = 'none';
            }
        }
        
        function populateNoteCategoryDropdown() {
            const categorySelect = document.getElementById('noteCategory');
            const filterCategorySelect = document.getElementById('filterNoteCategory');
            
            let options = '<option value="">Select category...</option>';
            let filterOptions = '<option value="all">All Categories</option>';
            
            Object.keys(categoryBudgets).forEach(type => {
                Object.keys(categoryBudgets[type]).forEach(category => {
                    options += `<option value="${type}|${category}">${category} (${type})</option>`;
                    filterOptions += `<option value="${type}|${category}">${category}</option>`;
                });
            });
            
            categorySelect.innerHTML = options;
            filterCategorySelect.innerHTML = filterOptions;
        }
        
        function populateNoteUserDropdown() {
            const userSelect = document.getElementById('noteToUser');
            const expenseUsers = [...new Set(expenses.map(e => e.submittedBy))];
            const allUsers = [...new Set([...expenseUsers, ...registeredUsers])].filter(u => u !== userName && u);
            
            let options = '<option value="">Select user to ask...</option>';
            allUsers.forEach(user => {
                options += `<option value="${user}">${user}</option>`;
            });
            
            userSelect.innerHTML = options;
        }
        
        async function addBudgetNote(event) {
            event.preventDefault();
            
            const categoryValue = document.getElementById('noteCategory').value;
            const [categoryType, category] = categoryValue.split('|');
            const noteType = document.getElementById('noteType').value;
            const message = document.getElementById('noteMessage').value;
            const toUser = document.getElementById('noteToUser').value;
            
            const note = {
                id: Date.now(),
                categoryType,
                category,
                noteType,
                message,
                fromUser: userName,
                toUser: noteType === 'question' ? toUser : '',
                timestamp: new Date().toISOString(),
                isRead: false
            };
            
            const success = await syncData('addBudgetNote', note);
            
            if (success) {
                budgetNotes.push(note);
                document.getElementById('budgetNoteForm').reset();
                document.getElementById('noteToUserGroup').style.display = 'none';
                renderBudgetNotes();
                alert('Budget note submitted successfully!');
            }
        }
        
        function renderBudgetNotes() {
            const container = document.getElementById('budgetNotesList');
            const categoryFilter = document.getElementById('filterNoteCategory').value;
            const typeFilter = document.getElementById('filterNoteType').value;
            
            let filteredNotes = [...budgetNotes];
            
            // Apply filters
            if (categoryFilter !== 'all') {
                const [filterType, filterCat] = categoryFilter.split('|');
                filteredNotes = filteredNotes.filter(n => n.categoryType === filterType && n.category === filterCat);
            }
            
            if (typeFilter !== 'all') {
                filteredNotes = filteredNotes.filter(n => n.noteType === typeFilter);
            }
            
            // Sort by date (newest first)
            filteredNotes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (filteredNotes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No budget notes yet</p>
                        <small>Add a note to explain budget overruns or ask team members</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredNotes.map(note => {
                const typeIcon = note.noteType === 'explanation' ? 'üìù' : 
                               note.noteType === 'question' ? '‚ùì' : 'üí¨';
                const typeLabel = note.noteType === 'explanation' ? 'Explanation' : 
                                note.noteType === 'question' ? 'Question' : 'Response';
                const typeBgColor = note.noteType === 'explanation' ? 'rgba(16, 185, 129, 0.2)' : 
                                  note.noteType === 'question' ? 'rgba(251, 191, 36, 0.2)' : 'rgba(59, 130, 246, 0.2)';
                const typeColor = note.noteType === 'explanation' ? '#10b981' : 
                                note.noteType === 'question' ? '#fbbf24' : '#3b82f6';
                
                const toUserText = note.toUser ? `<span style="color: #94a3b8;"> ‚Üí ${note.toUser}</span>` : '';
                
                return `
                    <div style="background: #1e293b; border: 1px solid #475569; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <div>
                                <span style="background: ${typeBgColor}; color: ${typeColor}; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">
                                    ${typeIcon} ${typeLabel}
                                </span>
                                <span style="margin-left: 12px; color: #fbbf24; font-weight: 500;">${note.category}</span>
                            </div>
                            <span style="color: #64748b; font-size: 0.75rem;">${formatDate(note.timestamp)}</span>
                        </div>
                        
                        <div style="color: #94a3b8; font-size: 0.75rem; margin-bottom: 8px;">
                            From: <span style="color: white;">${note.fromUser}</span>${toUserText}
                        </div>
                        
                        <div style="color: #cbd5e1; line-height: 1.6; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            ${note.message}
                        </div>
                        
                        ${note.noteType === 'question' && (note.toUser === userName || isAdmin) ? `
                            <button class="btn btn-secondary btn-small" style="margin-top: 12px;" onclick="replyToNote(${note.id}, '${note.category}', '${note.fromUser}')">
                                üí¨ Reply
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function replyToNote(noteId, category, fromUser) {
            // Find the category in dropdown
            const categorySelect = document.getElementById('noteCategory');
            for (let option of categorySelect.options) {
                if (option.text.includes(category)) {
                    categorySelect.value = option.value;
                    break;
                }
            }
            
            // Set note type to response
            document.getElementById('noteType').value = 'response';
            
            // Pre-fill message with reference
            document.getElementById('noteMessage').value = `Re: Question from ${fromUser}\n\n`;
            document.getElementById('noteMessage').focus();
            
            // Scroll to form
            document.getElementById('budgetNoteForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Initialize
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('expenseDueDate').value = new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0];
        
        checkSetup();
        if (webAppUrl && userName && userPassword) {
            loadData();
        }
    </script>
</body>
</html>