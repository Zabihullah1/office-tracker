<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Expense & Invoice Tracker</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@300;400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #1e293b 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        
        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            color: #fbbf24;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #94a3b8;
            font-weight: 300;
        }
        
        .user-info {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .setup-banner {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border: 1px solid #ef4444;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .setup-banner.success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            border-color: #10b981;
        }
        
        .setup-banner .icon {
            font-size: 2rem;
        }
        
        .setup-banner .content {
            flex: 1;
        }
        
        .setup-banner h3 {
            font-size: 1.125rem;
            margin-bottom: 4px;
        }
        
        .setup-banner p {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .setup-banner button {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: 500;
        }
        
        .setup-banner button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 30px;
            border-bottom: 2px solid #475569;
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab:hover {
            color: #fbbf24;
        }
        
        .tab.active {
            color: #fbbf24;
            border-bottom-color: #fbbf24;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #475569;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #334155;
        }
        
        .btn-success {
            background: #059669;
            color: white;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.875rem;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }
        
        .summary-card h3 {
            color: #fbbf24;
            font-size: 1.25rem;
            margin-bottom: 4px;
        }
        
        .summary-card .amount {
            font-size: 2rem;
            font-weight: 600;
            color: white;
            margin-top: 12px;
        }
        
        .summary-card .subtitle {
            color: #94a3b8;
            font-size: 0.875rem;
        }
        
        .section {
            background: #334155;
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
        }
        
        .section h2 {
            color: #fbbf24;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #1e293b;
            padding: 12px;
            text-align: left;
            color: #94a3b8;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        td {
            padding: 12px;
            border-top: 1px solid #475569;
        }
        
        tr:hover {
            background: #3f4f5f;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .status-approved {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .status-rejected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .status-paid {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .status-unpaid {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #334155;
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-header h3 {
            color: #fbbf24;
            font-size: 1.5rem;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }
        
        .close-btn:hover {
            color: white;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: #e2e8f0;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #fbbf24;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .form-actions button {
            flex: 1;
        }
        
        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 0.875rem;
            color: #93c5fd;
        }
        
        .code-box {
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 6px;
            padding: 12px;
            font-family: monospace;
            font-size: 0.875rem;
            overflow-x: auto;
            margin: 12px 0;
        }
        
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.875rem;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-state p {
            color: #94a3b8;
            font-size: 1.125rem;
        }
        
        .empty-state small {
            color: #64748b;
            font-size: 0.875rem;
            display: block;
            margin-top: 8px;
        }
        
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filters select,
        .filters input {
            padding: 10px 16px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 0.875rem;
            }
            
            th, td {
                padding: 8px;
            }
            
            .tabs {
                font-size: 0.875rem;
            }
            
            .tab {
                padding: 10px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Office Expense & Invoice Tracker</h1>
            <p>Track expenses and invoices with approval workflow</p>
        </div>
        
        <div class="user-info" id="userInfo">
            <div>
                <strong>User:</strong> <span id="userName">Not logged in</span>
                <span id="userRole" style="margin-left: 12px; color: #fbbf24;"></span>
            </div>
            <button class="btn btn-secondary btn-small" onclick="logout()">Change User</button>
        </div>
        
        <!-- Setup Banner -->
        <div id="setupBanner" class="setup-banner">
            <div class="icon">‚ö†Ô∏è</div>
            <div class="content">
                <h3>Google Sheets Not Connected</h3>
                <p>Configure your Google Sheets connection to start tracking</p>
            </div>
            <button onclick="openSetupModal()">Setup Now</button>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
            <div class="sync-status" id="syncStatus">
                <div class="loading"></div>
                <span>Syncing...</span>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
                <button class="btn btn-secondary" onclick="openCategoryModal()" id="manageCategoriesBtn" style="display: none;">üìù Manage Categories</button>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('expenses')">üí∞ Submit Expense</button>
            <button class="tab" onclick="switchTab('invoices')">üìÑ Add Invoice</button>
            <button class="tab" onclick="switchTab('history')">üìã History</button>
            <button class="tab" id="approvalsTab" onclick="switchTab('approvals')" style="display: none;">‚úÖ Approvals</button>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Total Incoming</h3>
                    <div class="subtitle">Client Invoices</div>
                    <div class="amount" id="totalIncoming">PKR 0</div>
                </div>
                <div class="summary-card">
                    <h3>Total Expenses</h3>
                    <div class="subtitle">Approved Only</div>
                    <div class="amount" id="totalExpenses">PKR 0</div>
                </div>
                <div class="summary-card">
                    <h3>Net Balance</h3>
                    <div class="subtitle">Incoming - Expenses</div>
                    <div class="amount" id="netBalance">PKR 0</div>
                </div>
                <div class="summary-card" id="pendingCard" style="display: none;">
                    <h3>Pending Approvals</h3>
                    <div class="subtitle">Awaiting Review</div>
                    <div class="amount" id="pendingCount">0</div>
                </div>
            </div>
            
            <div class="section">
                <h2>Recent Activity</h2>
                <div id="recentActivity"></div>
            </div>
        </div>
        
        <!-- Submit Expense Tab -->
        <div id="expenses" class="tab-content">
            <div class="section">
                <h2>Submit New Expense</h2>
                <form id="expenseForm" onsubmit="submitExpense(event)">
                    <div class="form-group">
                        <label>Category Type</label>
                        <select id="expenseCategoryType" onchange="updateExpenseCategories()" required>
                            <option value="">Select type...</option>
                            <option value="Variable Cost - Salary">Variable Cost - Salary</option>
                            <option value="Variable Cost - Operational">Variable Cost - Operational</option>
                            <option value="Fixed Cost - Subscription">Fixed Cost - Subscription</option>
                            <option value="One Time Cost - Description">One Time Cost - Description</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Category</label>
                        <select id="expenseCategory" required>
                            <option value="">Select category type first...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Amount (PKR)</label>
                        <input type="number" id="expenseAmount" placeholder="0" required min="0" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Description / Receipt Notes</label>
                        <textarea id="expenseNotes" placeholder="Add details about this expense..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Submit for Approval</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Add Invoice Tab -->
        <div id="invoices" class="tab-content">
            <div class="section">
                <h2>Add New Invoice</h2>
                <form id="invoiceForm" onsubmit="submitInvoice(event)">
                    <div class="form-group">
                        <label>Invoice Number</label>
                        <input type="text" id="invoiceNumber" placeholder="INV-001" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Client Name</label>
                        <input type="text" id="clientName" placeholder="Client name" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Amount (PKR)</label>
                        <input type="number" id="invoiceAmount" placeholder="0" required min="0" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label>Invoice Date</label>
                        <input type="date" id="invoiceDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="invoiceDueDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Status</label>
                        <select id="invoiceStatus" required>
                            <option value="Unpaid">Unpaid</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes (optional)</label>
                        <textarea id="invoiceNotes" placeholder="Additional details..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Add Invoice</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div class="section">
                <h2>Transaction History</h2>
                
                <div class="filters">
                    <select id="filterType" onchange="renderHistory()">
                        <option value="all">All Types</option>
                        <option value="expense">Expenses Only</option>
                        <option value="invoice">Invoices Only</option>
                    </select>
                    <select id="filterStatus" onchange="renderHistory()">
                        <option value="all">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Paid">Paid</option>
                        <option value="Unpaid">Unpaid</option>
                    </select>
                    <input type="date" id="filterDateFrom" onchange="renderHistory()" placeholder="From">
                    <input type="date" id="filterDateTo" onchange="renderHistory()" placeholder="To">
                </div>
                
                <div id="historyTable"></div>
            </div>
        </div>
        
        <!-- Approvals Tab (Admin Only) -->
        <div id="approvals" class="tab-content">
            <div class="section">
                <h2>Pending Approvals</h2>
                <div id="approvalsTable"></div>
            </div>
        </div>
    </div>
    
    <!-- Setup Modal -->
    <div id="setupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Google Sheets Setup</h3>
                <button class="close-btn" onclick="closeSetupModal()">√ó</button>
            </div>
            
            <div class="info-box">
                ‚ÑπÔ∏è First time setup: Create Google Apps Script and connect your Google Sheet
            </div>
            
            <form id="setupForm" onsubmit="saveSetup(event)">
                <div class="form-group">
                    <label>Your Name</label>
                    <input type="text" id="setupUserName" placeholder="Enter your name" required>
                </div>
                
                <div class="form-group">
                    <label>Are you the admin (Zabih Ullah)?</label>
                    <select id="setupIsAdmin" required>
                        <option value="">Select...</option>
                        <option value="yes">Yes - I am Zabih Ullah (Admin)</option>
                        <option value="no">No - I am a team member</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Google Sheets Web App URL</label>
                    <input 
                        type="url" 
                        id="webAppUrl" 
                        placeholder="https://script.google.com/macros/s/YOUR_ID/exec"
                        required
                    >
                    <p style="font-size: 0.75rem; color: #94a3b8; margin-top: 4px;">
                        See setup instructions for how to get this URL
                    </p>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeSetupModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save & Connect</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Manage Categories Modal -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Categories</h3>
                <button class="close-btn" onclick="closeCategoryModal()">√ó</button>
            </div>
            
            <div class="info-box">
                ‚ÑπÔ∏è Add or remove expense categories. Changes will sync across all devices.
            </div>
            
            <div class="form-group">
                <label>Category Type</label>
                <select id="manageCategoryType" onchange="displayCategories()">
                    <option value="Variable Cost - Salary">Variable Cost - Salary</option>
                    <option value="Variable Cost - Operational">Variable Cost - Operational</option>
                    <option value="Fixed Cost - Subscription">Fixed Cost - Subscription</option>
                    <option value="One Time Cost - Description">One Time Cost - Description</option>
                </select>
            </div>
            
            <div id="categoryList" style="margin: 20px 0;"></div>
            
            <form id="addCategoryForm" onsubmit="addNewCategory(event)">
                <h4 style="color: #fbbf24; margin-bottom: 12px; font-size: 1.125rem;">Add New Category</h4>
                
                <div class="form-group">
                    <label>Category Name</label>
                    <input type="text" id="newCategoryName" placeholder="e.g., Marketing Expenses" required>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">Close</button>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Initial categories from screenshot
        let categories = {
            'Variable Cost - Salary': ['Salaries', 'Saturday Over Time', 'Late Shift'],
            'Variable Cost - Operational': [
                'Allowance Portal',
                'Chat GPT Subscription',
                'Employee Post, Freight and Travelling Expenses',
                'Employee Mobile Expense',
                'Grocery and Crockery Expense',
                'Team/s Lunch Expense',
                'Electricity Charges (R.A.)',
                'Waste Bill (R.A.)',
                'Jamar Security Services',
                'Repair and Maintenance',
                'Water Supply',
                'Employee Gym Fee',
                'UPS Repair and Maintenance',
                'Diesel Supply for Genset',
                'Miscellaneous Expense',
                'Office Furniture',
                'Pet Care/ Insurance',
                'Employee Activity Expense',
                'Entertainment Expense',
                'Ramzan Expense',
                'Eid Serice Agreement',
                'IP Guys',
                'Stationary Expense'
            ],
            'Fixed Cost - Subscription': [
                'MultiMD CRM 20Mbps',
                'Wateen Telecom',
                'Ptcl',
                'Storm Fiber'
            ],
            'One Time Cost - Description': [
                'Exchange rate difference',
                'Fed Duty 1% of overall invoice'
            ]
        };
        
        let expenses = [];
        let invoices = [];
        let webAppUrl = localStorage.getItem('officeWebAppUrl') || '';
        let userName = localStorage.getItem('officeUserName') || '';
        let isAdmin = localStorage.getItem('officeIsAdmin') === 'true';
        
        function updateSyncStatus(message, isError = false) {
            const status = document.getElementById('syncStatus');
            if (isError) {
                status.innerHTML = `<span style="color: #ef4444;">‚ö†Ô∏è</span><span>${message}</span>`;
            } else if (message === 'loading') {
                status.innerHTML = `<div class="loading"></div><span>Syncing...</span>`;
            } else {
                status.innerHTML = `<span style="color: #10b981;">‚úì</span><span>${message}</span>`;
            }
        }
        
        function checkSetup() {
            if (!webAppUrl || !userName) {
                document.getElementById('setupBanner').style.display = 'flex';
                updateSyncStatus('Not connected', true);
                return false;
            } else {
                document.getElementById('setupBanner').style.display = 'none';
                document.getElementById('userName').textContent = userName;
                document.getElementById('userRole').textContent = isAdmin ? '(Admin)' : '(Team Member)';
                
                if (isAdmin) {
                    document.getElementById('approvalsTab').style.display = 'block';
                    document.getElementById('pendingCard').style.display = 'block';
                    document.getElementById('manageCategoriesBtn').style.display = 'inline-flex';
                }
                
                return true;
            }
        }
        
        async function loadData() {
            if (!checkSetup()) return;
            
            updateSyncStatus('loading');
            
            try {
                const response = await fetch(webAppUrl);
                const data = await response.json();
                
                expenses = data.expenses || [];
                invoices = data.invoices || [];
                
                if (data.categories && Object.keys(data.categories).length > 0) {
                    categories = data.categories;
                } else {
                    await syncCategories();
                }
                
                updateSyncStatus('Synced');
                renderAll();
            } catch (error) {
                console.error('Error loading data:', error);
                updateSyncStatus('Sync failed', true);
                alert('Failed to load data from Google Sheets. Please check your setup.');
            }
        }
        
        async function syncCategories() {
            if (!checkSetup()) return false;
            
            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'updateCategories',
                        categories: categories
                    })
                });
                
                const result = await response.json();
                return result.success;
            } catch (error) {
                console.error('Error syncing categories:', error);
                return false;
            }
        }
        
        async function syncData(action, data) {
            if (!checkSetup()) return false;
            
            updateSyncStatus('loading');
            
            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action,
                        ...data
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateSyncStatus('Synced');
                    return true;
                } else {
                    updateSyncStatus('Sync failed', true);
                    return false;
                }
            } catch (error) {
                console.error('Error syncing:', error);
                updateSyncStatus('Sync failed', true);
                alert('Failed to sync with Google Sheets. Please try again.');
                return false;
            }
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        function openSetupModal() {
            document.getElementById('setupModal').classList.add('active');
            if (webAppUrl) {
                document.getElementById('webAppUrl').value = webAppUrl;
                document.getElementById('setupUserName').value = userName;
                document.getElementById('setupIsAdmin').value = isAdmin ? 'yes' : 'no';
            }
        }
        
        function closeSetupModal() {
            document.getElementById('setupModal').classList.remove('active');
        }
        
        function saveSetup(event) {
            event.preventDefault();
            
            const url = document.getElementById('webAppUrl').value.trim();
            const name = document.getElementById('setupUserName').value.trim();
            const adminStatus = document.getElementById('setupIsAdmin').value === 'yes';
            
            if (!url.includes('script.google.com')) {
                alert('Please enter a valid Google Apps Script Web App URL');
                return;
            }
            
            webAppUrl = url;
            userName = name;
            isAdmin = adminStatus;
            
            localStorage.setItem('officeWebAppUrl', url);
            localStorage.setItem('officeUserName', name);
            localStorage.setItem('officeIsAdmin', adminStatus);
            
            document.getElementById('setupBanner').innerHTML = `
                <div class="icon">‚úì</div>
                <div class="content">
                    <h3>Connected to Google Sheets</h3>
                    <p>Your data is now syncing</p>
                </div>
                <button onclick="openSetupModal()">Reconfigure</button>
            `;
            document.getElementById('setupBanner').className = 'setup-banner success';
            
            closeSetupModal();
            checkSetup();
            loadData();
        }
        
        function logout() {
            if (confirm('Change user? This will clear your login.')) {
                localStorage.removeItem('officeUserName');
                localStorage.removeItem('officeIsAdmin');
                userName = '';
                isAdmin = false;
                location.reload();
            }
        }
        
        function updateExpenseCategories() {
            const type = document.getElementById('expenseCategoryType').value;
            const select = document.getElementById('expenseCategory');
            
            if (!type) {
                select.innerHTML = '<option value="">Select category type first...</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Select category...</option>' +
                categories[type].map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }
        
        async function submitExpense(event) {
            event.preventDefault();
            
            const expense = {
                id: Date.now(),
                type: 'expense',
                categoryType: document.getElementById('expenseCategoryType').value,
                category: document.getElementById('expenseCategory').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                date: document.getElementById('expenseDate').value,
                notes: document.getElementById('expenseNotes').value,
                submittedBy: userName,
                status: 'Pending',
                submittedAt: new Date().toISOString()
            };
            
            const success = await syncData('addExpense', expense);
            
            if (success) {
                alert('Expense submitted for approval!');
                document.getElementById('expenseForm').reset();
                await loadData();
                switchTab('history');
            }
        }
        
        async function submitInvoice(event) {
            event.preventDefault();
            
            const invoice = {
                id: Date.now(),
                type: 'invoice',
                invoiceNumber: document.getElementById('invoiceNumber').value,
                clientName: document.getElementById('clientName').value,
                amount: parseFloat(document.getElementById('invoiceAmount').value),
                date: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('invoiceDueDate').value,
                status: document.getElementById('invoiceStatus').value,
                notes: document.getElementById('invoiceNotes').value,
                addedBy: userName,
                addedAt: new Date().toISOString()
            };
            
            const success = await syncData('addInvoice', invoice);
            
            if (success) {
                alert('Invoice added successfully!');
                document.getElementById('invoiceForm').reset();
                await loadData();
                switchTab('dashboard');
            }
        }
        
        async function approveExpense(id) {
            const success = await syncData('approveExpense', { id, approvedBy: userName });
            if (success) {
                await loadData();
            }
        }
        
        async function rejectExpense(id) {
            const reason = prompt('Reason for rejection (optional):');
            const success = await syncData('rejectExpense', { id, rejectedBy: userName, reason });
            if (success) {
                await loadData();
            }
        }
        
        function formatCurrency(amount) {
            return 'PKR ' + amount.toLocaleString('en-PK');
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }
        
        function renderAll() {
            renderDashboard();
            renderHistory();
            if (isAdmin) {
                renderApprovals();
            }
        }
        
        function renderDashboard() {
            const totalIncoming = invoices.reduce((sum, inv) => sum + inv.amount, 0);
            const totalExpenses = expenses.filter(e => e.status === 'Approved').reduce((sum, e) => sum + e.amount, 0);
            const netBalance = totalIncoming - totalExpenses;
            const pendingCount = expenses.filter(e => e.status === 'Pending').length;
            
            document.getElementById('totalIncoming').textContent = formatCurrency(totalIncoming);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('netBalance').textContent = formatCurrency(netBalance);
            if (isAdmin) {
                document.getElementById('pendingCount').textContent = pendingCount;
            }
            
            // Recent activity
            const allItems = [...expenses, ...invoices].sort((a, b) => 
                new Date(b.submittedAt || b.addedAt) - new Date(a.submittedAt || a.addedAt)
            ).slice(0, 10);
            
            const container = document.getElementById('recentActivity');
            
            if (allItems.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No activity yet</p><small>Start by submitting an expense or adding an invoice</small></div>';
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th style="text-align: right;">Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allItems.map(item => `
                            <tr>
                                <td>${formatDate(item.date)}</td>
                                <td>${item.type === 'expense' ? 'üí∞ Expense' : 'üìÑ Invoice'}</td>
                                <td>${item.type === 'expense' ? item.category : item.clientName}</td>
                                <td style="text-align: right; font-weight: 500;">${formatCurrency(item.amount)}</td>
                                <td><span class="status-badge status-${item.status.toLowerCase()}">${item.status}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function renderHistory() {
            const typeFilter = document.getElementById('filterType').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            
            let items = [...expenses, ...invoices];
            
            if (typeFilter !== 'all') {
                items = items.filter(item => item.type === typeFilter);
            }
            
            if (statusFilter !== 'all') {
                items = items.filter(item => item.status === statusFilter);
            }
            
            if (dateFrom) {
                items = items.filter(item => new Date(item.date) >= new Date(dateFrom));
            }
            
            if (dateTo) {
                items = items.filter(item => new Date(item.date) <= new Date(dateTo));
            }
            
            items.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const container = document.getElementById('historyTable');
            
            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No transactions found</p><small>Try adjusting your filters</small></div>';
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Category/Client</th>
                            <th style="text-align: right;">Amount</th>
                            <th>Status</th>
                            <th>Submitted By</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td>${formatDate(item.date)}</td>
                                <td>${item.type === 'expense' ? 'üí∞ Expense' : 'üìÑ Invoice'}</td>
                                <td>${item.type === 'expense' ? item.category : item.clientName}</td>
                                <td style="text-align: right; font-weight: 500;">${formatCurrency(item.amount)}</td>
                                <td><span class="status-badge status-${item.status.toLowerCase()}">${item.status}</span></td>
                                <td>${item.submittedBy || item.addedBy}</td>
                                <td style="font-size: 0.875rem; color: #94a3b8;">${item.notes || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function renderApprovals() {
            const pending = expenses.filter(e => e.status === 'Pending');
            const container = document.getElementById('approvalsTable');
            
            if (pending.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No pending approvals</p><small>All expenses have been reviewed</small></div>';
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Submitted By</th>
                            <th>Category</th>
                            <th style="text-align: right;">Amount</th>
                            <th>Notes</th>
                            <th style="text-align: right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pending.map(expense => `
                            <tr>
                                <td>${formatDate(expense.date)}</td>
                                <td>${expense.submittedBy}</td>
                                <td>${expense.category}</td>
                                <td style="text-align: right; font-weight: 500;">${formatCurrency(expense.amount)}</td>
                                <td style="font-size: 0.875rem; color: #94a3b8;">${expense.notes || '-'}</td>
                                <td style="text-align: right;">
                                    <button class="btn btn-success btn-small" onclick="approveExpense(${expense.id})">‚úì Approve</button>
                                    <button class="btn btn-danger btn-small" onclick="rejectExpense(${expense.id})">‚úï Reject</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function openCategoryModal() {
            document.getElementById('categoryModal').classList.add('active');
            displayCategories();
        }
        
        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
        }
        
        function displayCategories() {
            const type = document.getElementById('manageCategoryType').value;
            const cats = categories[type];
            const container = document.getElementById('categoryList');
            
            container.innerHTML = `
                <div style="background: #1e293b; border: 1px solid #475569; border-radius: 8px; padding: 16px;">
                    <h4 style="color: #fbbf24; margin-bottom: 12px; font-size: 1rem;">Current Categories</h4>
                    ${cats.map(name => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #475569;">
                            <div style="color: white; font-weight: 500;">${name}</div>
                            <button 
                                class="btn btn-danger btn-small" 
                                onclick="removeCategory('${type}', '${name}')"
                            >‚úï</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        async function addNewCategory(event) {
            event.preventDefault();
            
            const type = document.getElementById('manageCategoryType').value;
            const name = document.getElementById('newCategoryName').value.trim();
            
            if (!name) {
                alert('Please enter a category name');
                return;
            }
            
            if (categories[type].includes(name)) {
                alert('Category already exists!');
                return;
            }
            
            categories[type].push(name);
            
            const success = await syncCategories();
            
            if (success) {
                document.getElementById('addCategoryForm').reset();
                displayCategories();
                alert(`Category "${name}" added successfully!`);
            } else {
                categories[type].pop();
                alert('Failed to sync category. Please try again.');
            }
        }
        
        async function removeCategory(type, name) {
            if (!confirm(`Remove category "${name}"?`)) return;
            
            const index = categories[type].indexOf(name);
            const backup = categories[type][index];
            categories[type].splice(index, 1);
            
            const success = await syncCategories();
            
            if (success) {
                displayCategories();
            } else {
                categories[type].splice(index, 0, backup);
                alert('Failed to sync changes. Please try again.');
            }
        }
        
        async function refreshData() {
            await loadData();
        }
        
        // Initialize
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('invoiceDueDate').value = new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0];
        
        checkSetup();
        if (webAppUrl && userName) {
            loadData();
        }
    </script>
</body>
</html>